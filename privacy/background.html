<html>
<script>

//########### Facebook iframes
var likeURL = chrome.extension.getURL("like.html");
//secret key used to verify requests from our pages. 
//This allows us not to keep track of visited pages as shown in the WebRequest implementation page
var secret = "secret="+Math.floor(Math.random()*10001); 

var likeSub = function(details) 
{
	if(details.url.indexOf(secret) > 0)
		return;
	return {redirectUrl: likeURL + "#" + encodeURIComponent(details.url) + "#"+secret};
};
chrome.webRequest.onBeforeRequest.addListener(likeSub, {urls: ["*://*.facebook.com/plugins/*"], types: ["main_frame","sub_frame"]}, ["blocking"]);

//########### Facebook XFBML
var xfbmlFakeURL = chrome.extension.getURL("xfbml_fake.js");
var xfbmlLoadURL = chrome.extension.getURL("xfbml_load.js");
chrome.webRequest.onBeforeRequest.addListener(function(details){
	if(details.url.indexOf(secret) > 0)
		return;
	//xfbml loaded first, show page action
	chrome.pageAction.show(details.tabId);
	return {redirectUrl: xfbmlFakeURL};
}, {urls: 
//afaik, all.js is distributed by (facebook|fbcdn)\.(com|net)
["*://*.facebook.com/*/all.js*","*://*.fbcdn.net/*/all.js*","*://*.facebook.net/*/all.js*","*://*.fbcdn.com/*/all.js*"], 
types: ["script"]}, ["blocking"]);

var executionEnvEscapeScript = //Code can be so dirty :o
	"var scripts = document.getElementsByTagName('script');"+
	"var fbTest  = /(facebook|fbcdn)\.(com|net)\\/.+\\/all\.js/;"+
	"for(var i=0; i < scripts.length; i++)"+
		"if(fbTest.test(scripts[i].src)) "+
			"scripts[i].src = \""+xfbmlLoadURL+"#\" + encodeURIComponent(scripts[i].src) + \"#"+secret+"\";";
chrome.pageAction.onClicked.addListener(function(tab) {
	//var message = (tabStatus && tabStatus[tab.id] && tabStatus[tab.id] > 0) ? "allow-always" : "allow-once";
	//console.debug(ports[tab.id],message);
	chrome.tabs.executeScript(tab.id,{code:executionEnvEscapeScript,
	allFrames: true});
});

/*var ports = {};
var tabStatus = {};
chrome.pageAction.onClicked.addListener(function(tab) {
	var message = (tabStatus && tabStatus[tab.id] && tabStatus[tab.id] > 0) ? "allow-always" : "allow-once";
	console.debug(ports[tab.id],message);
	var tabPorts = ports[tab.id];
	for(var i in tabPorts)
	{
		tabPorts[i].postMessage({xfbml: message});
	}
});
chrome.extension.onConnect.addListener(function(port) {
  port.onMessage.addListener(function(msg) {
    if (msg.xfbml == "request")
	{
		console.debug(port,msg);
		chrome.pageAction.show(port.tab.id);
		if(port.tab.id in ports)
			ports[port.tab.id].push(port);
		else
			ports[port.tab.id] = [port];
		
	}
  });
});*/
  /* "content_scripts": [
	{
      */// "matches": ["http://*/*","https://*/*"], 
      /* "js": ["likeprivacy.js"],
	  "run_at": "document_start",
	  "all_frames": true
    }
  ], */
//chrome.tabs.onUpdated.addListener(checkForValidUrl);
</script>
</html>