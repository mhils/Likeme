<html>
<script>

//########### Facebook iframes
var likeURL = chrome.extension.getURL("like.html");
//secret key used to verify requests from our pages. 
//This allows us not to keep track of visited pages as shown in the WebRequest implementation page
var secret = "secret="+Math.floor(Math.random()*10001); 

var likeSub = function(details) 
{
	if(details.url.indexOf(secret) > 0)
		return;
	return {redirectUrl: likeURL + "#" + encodeURIComponent(details.url+"#"+secret)};
};
chrome.webRequest.onBeforeRequest.addListener(likeSub, {urls: ["*://*.facebook.com/plugins/*"], types: ["main_frame","sub_frame"]}, ["blocking"]);

//########### Facebook XFBML
var xfbmlURL = chrome.extension.getURL("fake_xfbml.js");
chrome.webRequest.onBeforeRequest.addListener(function(details){
	if(details.url.indexOf(secret) > 0)
		return;
	return {redirectUrl: likeURL + "#" + encodeURIComponent(details.url+"#"+secret)};
}, {urls: ["*://*.facebook.com/*/all.js*","*://*.fbcdn.net/*/all.js*","*://*.facebook.net/*/all.js*","*://*.fbcdn.com/*/all.js*"], types: ["script"]}, ["blocking"]);


/*var ports = {};
var tabStatus = {};
chrome.pageAction.onClicked.addListener(function(tab) {
	var message = (tabStatus && tabStatus[tab.id] && tabStatus[tab.id] > 0) ? "allow-always" : "allow-once";
	console.debug(ports[tab.id],message);
	var tabPorts = ports[tab.id];
	for(var i in tabPorts)
	{
		tabPorts[i].postMessage({xfbml: message});
	}
});
chrome.extension.onConnect.addListener(function(port) {
  port.onMessage.addListener(function(msg) {
    if (msg.xfbml == "request")
	{
		console.debug(port,msg);
		chrome.pageAction.show(port.tab.id);
		if(port.tab.id in ports)
			ports[port.tab.id].push(port);
		else
			ports[port.tab.id] = [port];
		
	}
  });
});*/
  /* "content_scripts": [
	{
      */// "matches": ["http://*/*","https://*/*"], 
      /* "js": ["likeprivacy.js"],
	  "run_at": "document_start",
	  "all_frames": true
    }
  ], */
//chrome.tabs.onUpdated.addListener(checkForValidUrl);
</script>
</html>