<html>
<script>
var ports = {};
var tabStatus = {};
chrome.pageAction.onClicked.addListener(function(tab) {
	var message = (tabStatus && tabStatus[tab.id] && tabStatus[tab.id] > 0) ? "allow-always" : "allow-once";
	console.debug(ports[tab.id],message);
	var tabPorts = ports[tab.id];
	for(var i in tabPorts)
	{
		tabPorts[i].postMessage({xfbml: message});
	}
});
chrome.extension.onConnect.addListener(function(port) {
  port.onMessage.addListener(function(msg) {
    if (msg.xfbml == "request")
	{
		console.debug(port,msg);
		chrome.pageAction.show(port.tab.id);
		if(port.tab.id in ports)
			ports[port.tab.id].push(port);
		else
			ports[port.tab.id] = [port];
		
	}
  });
});

//chrome.tabs.onUpdated.addListener(checkForValidUrl);
</script>
</html>